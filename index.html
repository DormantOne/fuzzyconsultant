<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Consultant Finder — Fuzzy (Bright)</title>
<style>
:root{
  /* Light, brighter palette */
  --bg:#f6f8ff; --ink:#121524; --muted:#5f6b85;
  --card:#ffffff; --border:#e5e9f5;
  --chip:#eef1ff; --chip-border:#d8def7;
  --primary:#6b2cff; --primary-2:#2f8cff; /* purple → blue gradient */
  --good:#1f8d4d; --warn:#c27a00;
  --radius:16px; --shadow:0 14px 40px rgba(31,45,95,.12);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.header{position:sticky;top:0;z-index:5;background:linear-gradient(90deg,#fff, #f0f3ff);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
.wrap{max-width:1080px;margin:0 auto;padding:16px}
h1{font-size:1.35rem;margin:0;color:#121524}
small{color:var(--muted)}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:1rem;color:#1b2340;background:#fafbff}
.body{padding:14px}
.input{display:flex;gap:10px;flex-wrap:wrap}
label{display:block;font-size:.9rem;color:#2a3250;margin-bottom:6px}
input[type=text],select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--ink);box-shadow:0 1px 0 rgba(0,0,0,.02)}
input[type=text]:focus, select:focus{outline:2px solid #d7e1ff}
button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:700}
.btn-primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#fff}
.btn-ghost{background:#fff;color:#2b3555;border:1px solid var(--border)}
.muted{color:var(--muted);font-size:.92rem}
.results{display:grid;gap:12px}
.card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px}
.card h4{margin:0 0 6px 0}
.score{font-weight:800}
.good{color:var(--good)}
.warn{color:var(--warn)}
.row{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.chip{background:var(--chip);color:#1e2650;border:1px solid var(--chip-border);padding:5px 10px;border-radius:18px;font-size:.83rem}
.hl{background:linear-gradient(transparent 65%, #fff470 65%);border-radius:3px;padding:0 2px}
.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-top:10px}
.kv .k{color:#3a4570}
pre{white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,Consolas,monospace;color:#1a2550;font-size:.9rem;background:#f4f6ff;border:1px solid var(--border);padding:10px;border-radius:10px}
.toggle-row{display:flex;justify-content:center;margin-top:16px}
.copy-row{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}
.hide{display:none}
@media(max-width:980px){.grid{grid-template-columns:1fr} .kv{grid-template-columns:120px 1fr}}
</style>
</head>
<body>
  <div class="header">
    <div class="wrap">
      <h1>Consultant Finder — Fuzzy</h1>
      <small>Search by provider, area, problem, or <b>keyword</b> (e.g., “AF ablation”, “dementia MoCA”, “BPH UroLift”). Reads <b>consultant.json</b>.</small>
    </div>
  </div>

  <div class="wrap" style="padding-top:14px;padding-bottom:24px">
    <!-- Search panel -->
    <section class="panel">
      <h3>Search</h3>
      <div class="body">
        <div class="input">
          <div style="flex:1 1 420px;min-width:260px">
            <label for="q">Query</label>
            <input id="q" type="text" placeholder="Provider, specialty, condition, or keyword…" aria-label="Search query" />
          </div>
          <div style="flex:1 1 240px;min-width:220px">
            <label for="area">Area</label>
            <select id="area" aria-label="Filter by area">
              <option value="">Any area</option>
            </select>
          </div>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <button class="btn-primary" id="findBtn" disabled>Find Consultants</button>
            <button class="btn-ghost" id="resetBtn">Reset</button>
          </div>
        </div>
        <p class="muted" style="margin-top:8px">Fuzzy scoring = exact word hits + 2–3 char substrings across all fields (incl. <b>keywords</b>).</p>
        <div id="stats" class="muted" style="margin-top:6px" aria-live="polite">Loading dataset…</div>
      </div>
    </section>

    <!-- Results -->
    <section class="panel" style="margin-top:16px">
      <h3>Results</h3>
      <div class="body">
        <div id="results" class="results"></div>
      </div>
    </section>

    <!-- Toggle for dataset -->
    <div class="toggle-row">
      <button class="btn-ghost" id="toggleDataset">Show Dataset</button>
    </div>

    <!-- Hidden dataset panel -->
    <section class="panel hide" id="datasetPanel" style="margin-top:16px">
      <h3>Consultant JSON (current set)</h3>
      <div class="body">
        <div class="copy-row">
          <button class="btn-ghost" id="copyJSON">Copy JSON</button>
        </div>
        <pre id="jsonView"></pre>
      </div>
    </section>
  </div>

<script>
/* ----------------- Load clinicians from adjacent consultant.json ----------------- */
let CLINICIANS = [];

document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('consultant.json', {cache:'no-store'});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    CLINICIANS = await res.json();

    // populate Area dropdown (unique areas only)
    const areas = [...new Set(CLINICIANS.map(c => c.area).filter(Boolean))].sort();
    const areaSel = $('area');
    for (const a of areas){
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = a;
      areaSel.appendChild(opt);
    }

    $('stats').textContent = `Loaded ${CLINICIANS.length} consultants.`;
    $('findBtn').disabled = false;

    // live typing (debounced)
    $('q').addEventListener('input', debounce(runSearch, 200));
  } catch (err) {
    $('stats').textContent = `Failed to load consultant.json (${err.message}).`;
    console.error(err);
  }
});

/* ----------------- Fuzzy Logic (kept simple, same spirit) ----------------- */
function calculateScore(input, targetText) {
  const inputWords = input.toLowerCase().split(/\s+/).filter(Boolean);
  const nameWords  = targetText.toLowerCase().split(/\s+/).filter(Boolean);
  let score = 0;

  for (let i = 0; i < inputWords.length; i++) {
    const inputWord = inputWords[i];
    if (nameWords.indexOf(inputWord) !== -1) {
      score += 10; // exact word
    }
  }
  for (let len = 2; len <= 3; len++) {
    for (let i = 0; i < input.length - len + 1; i++) {
      const segment = input.slice(i, i + len).toLowerCase();
      if (segment.trim().length < len) continue;
      if (targetText.toLowerCase().indexOf(segment) !== -1) {
        score += len * 3; // short substrings
      }
    }
  }
  return score;
}

/* Build the searchable string for each clinician — covers all JSON fields */
function clinicianSearchText(c){
  const parts = [];
  for (const [k,v] of Object.entries(c)){
    if (v == null) continue;
    if (Array.isArray(v)) parts.push(v.join(' '));
    else parts.push(String(v));
  }
  return parts.filter(Boolean).join(' ').toLowerCase();
}

/* Optional area hard-filter */
function areaMatches(areaFilter, c){
  if (!areaFilter) return true;
  const a = (c.area || '').toLowerCase();
  return a.includes(areaFilter.toLowerCase());
}

/* ----------------- UI ----------------- */
const $ = id => document.getElementById(id);

$('findBtn').addEventListener('click', runSearch);
$('resetBtn').addEventListener('click', () => {
  $('q').value = "";
  $('area').value = "";
  renderResults([]);
  $('stats').textContent = "Cleared.";
});
$('q').addEventListener('keydown', e => { if (e.key==='Enter') runSearch(); });

// Dataset toggle + copy
$('toggleDataset').addEventListener('click', () => {
  const panel = $('datasetPanel');
  const wasHidden = panel.classList.contains('hide');
  panel.classList.toggle('hide');
  $('toggleDataset').textContent = wasHidden ? "Hide Dataset" : "Show Dataset";
  if (wasHidden) $('jsonView').textContent = JSON.stringify(CLINICIANS, null, 2);
});
$('copyJSON').addEventListener('click', () => {
  const txt = JSON.stringify(CLINICIANS, null, 2);
  navigator.clipboard.writeText(txt).then(()=>alert('JSON copied')).catch(()=>alert('Copy failed'));
});

function runSearch(){
  const q = $('q').value.trim();
  const area = $('area').value;

  if (!CLINICIANS.length){
    $('stats').textContent = 'Dataset not loaded.';
    return;
  }

  const scored = CLINICIANS
    .filter(c => areaMatches(area, c))
    .map(c => {
      const searchable = clinicianSearchText(c);
      const score = q ? calculateScore(q, searchable) : 0;
      return { clinician: c, score, searchable };
    })
    .filter(x => q ? x.score > 0 : false)
    .sort((a,b) => b.score - a.score);

  renderResults(scored, q);
  $('stats').textContent = scored.length
    ? `Found ${scored.length} match${scored.length>1?'es':''}.`
    : (q ? `No matches. Try terms like "AF ablation", "dementia", "BPH UroLift".` : `Type a query to begin.`);
}

function renderResults(items, query=""){
  const box = $('results');
  box.innerHTML = "";
  if (!items || !items.length){
    box.innerHTML = `<div class="card muted">No results yet.</div>`;
    return;
  }
  for (const it of items){
    const c = it.clinician;
    const name = c.provider || c["name of individual"] || "—";
    const area = c.area || c["general area"] || "";
    const scoreClass = it.score >= 60 ? "good" : "warn";
    const scoreTxt = it.score.toFixed(0);

    // top chips: area + sub_area + hospitals (cap 3) + KEYWORDS (cap 10 shown)
    const chips = [];
    if (c.area) chips.push(`<span class="chip">${hl(c.area, query)}</span>`);
    if (c.sub_area) chips.push(`<span class="chip">${hl(c.sub_area, query)}</span>`);
    if (Array.isArray(c.hospital_affiliations)){
      for (const h of c.hospital_affiliations.slice(0,3)){
        chips.push(`<span class="chip">${hl(h, query)}</span>`);
      }
    }

    const kwRow = Array.isArray(c.keywords) && c.keywords.length
      ? `<div class="row" style="margin-top:6px"><strong style="margin-right:4px">Keywords:</strong> ${
          c.keywords.slice(0,10).map(k=>`<span class="chip">${hl(String(k), query)}</span>`).join(' ')
        }</div>`
      : "";

    // key–value table for remaining fields (avoid duplicating keywords in KV)
    const kv = Object.entries(c)
      .filter(([k]) => k !== 'keywords')
      .map(([k,v])=>{
        const niceK = toTitle(k);
        const val = Array.isArray(v)
          ? v.map(x=>`<span class="chip">${hl(String(x), query)}</span>`).join(' ')
          : hl(String(v), query);
        return `<div class="kv"><div class="k">${escapeHTML(niceK)}</div><div class="v">${val}</div></div>`;
      }).join("");

    const div = document.createElement('div');
    div.className = "card";
    div.innerHTML = `
      <h4>${escapeHTML(name)} <span class="muted">— ${escapeHTML(area)}</span></h4>
      <div class="muted">Score: <b class="score ${scoreClass}">${scoreTxt}</b></div>
      <div class="row" style="margin-top:8px">${chips.join(" ")}</div>
      ${kwRow}
      ${kv}
    `;
    box.appendChild(div);
  }

  // chips add to query
  box.querySelectorAll('.chip').forEach(ch => {
    ch.style.cursor = 'pointer';
    ch.title = 'Add to search';
    ch.addEventListener('click', () => {
      const qEl = $('q');
      const add = ch.textContent.trim();
      const existing = qEl.value.trim();
      qEl.value = existing ? existing + ' ' + add : add;
      runSearch();
      qEl.focus();
    });
  });
}

function hl(text, query){
  const t = String(text);
  if (!query) return escapeHTML(t);
  const qtok = query.toLowerCase().split(/\s+/).filter(x=>x.length>=3);
  if (!qtok.length) return escapeHTML(t);
  let out = escapeHTML(t);
  for (const q of qtok){
    const re = new RegExp(`(${escapeReg(q)})`,"ig");
    out = out.replace(re,'<span class="hl">$1</span>');
  }
  return out;
}

function toTitle(s){ return String(s).replace(/_/g,' ').replace(/\b\w/g, m => m.toUpperCase()); }
function escapeHTML(s){ return String(s).replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m])); }
function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function debounce(fn, ms=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

/* Initial state */
renderResults([]);
</script>
</body>
</html>
