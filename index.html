<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Consultant Finder — Fuzzy</title>
<style>
:root{
  /* brighter but still dark */
  --primary:#7b2cff; --primary-2:#a55cff; --bg:#0d1020; --card:#151a2e; --ink:#f3f5ff;
  --muted:#b3bbcc; --good:#27ae60; --warn:#f5a623; --border:#2a3350; --chip:#1e2542;
  --radius:14px; --shadow:0 14px 38px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.header{position:sticky;top:0;z-index:5;background:rgba(10,12,24,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
.wrap{max-width:1080px;margin:0 auto;padding:16px}
h1{font-size:1.25rem;margin:0;color:#efe9ff}
small{color:var(--muted)}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:1rem;color:#e6e8ff}
.body{padding:14px}
.input{display:flex;gap:10px;flex-wrap:wrap}
label{display:block;font-size:.9rem;color:#d7dbff}
input[type=text],select{width:100%;padding:12px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1430;color:#f0f3ff}
button{cursor:pointer;border:none;border-radius:10px;padding:12px 16px;font-weight:700}
.btn-primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#fff}
.btn-ghost{background:#0f1430;color:#f0f3ff;border:1px solid var(--border)}
.muted{color:var(--muted);font-size:.9rem}
.results{display:grid;gap:10px}
.card{background:#0f1430;border:1px solid var(--border);border-radius:12px;padding:12px}
.card h4{margin:0 0 6px 0}
.score{font-weight:800}
.good{color:var(--good)}
.warn{color:var(--warn)}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.chip{background:var(--chip);color:#e8ecff;border:1px solid #394377;padding:4px 8px;border-radius:20px;font-size:.8rem}
.hit{background:rgba(124,58,237,.18);border-color:#623de3}
.hl{background:rgba(255,240,0,.22);padding:0 3px;border-radius:4px}
.kv{display:grid;grid-template-columns:140px 1fr;gap:6px;margin-top:10px}
.kv .k{color:#cfd6ff}
pre{white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,Consolas,monospace;color:#d8e5ff;font-size:.9rem}
.toggle-row{display:flex;justify-content:center;margin-top:16px}
.copy-row{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}
.hide{display:none}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="header">
    <div class="wrap">
      <h1>Consultant Finder — Fuzzy</h1>
      <small>Search by provider, area, or problem (e.g., “BPH TURP”, “electrophysiology AF”, “dementia”). Reads from <b>consultant.json</b>.</small>
    </div>
  </div>

  <div class="wrap" style="padding-top:14px;padding-bottom:24px">
    <!-- Search panel -->
    <section class="panel">
      <h3>Search</h3>
      <div class="body">
        <div class="input">
          <div style="flex:1 1 420px;min-width:260px">
            <label for="q">Query</label>
            <input id="q" type="text" placeholder="What is the procedure, specialty, provider, or problem?" aria-label="Search query" />
          </div>
          <div style="flex:1 1 240px;min-width:220px">
            <label for="area">Area</label>
            <select id="area" aria-label="Filter by area">
              <option value="">Any area</option>
            </select>
          </div>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <button class="btn-primary" id="findBtn" disabled>Find Consultants</button>
            <button class="btn-ghost" id="resetBtn">Reset</button>
          </div>
        </div>
        <p class="muted" style="margin-top:8px">Fuzzy scoring = exact word hits + 2–3 char substrings across all fields; results show every field from the JSON.</p>
        <div id="stats" class="muted" style="margin-top:6px" aria-live="polite">Loading dataset…</div>
      </div>
    </section>

    <!-- Results -->
    <section class="panel" style="margin-top:16px">
      <h3>Results</h3>
      <div class="body">
        <div id="results" class="results"></div>
      </div>
    </section>

    <!-- Toggle for dataset -->
    <div class="toggle-row">
      <button class="btn-ghost" id="toggleDataset">Show Dataset</button>
    </div>

    <!-- Hidden dataset panel -->
    <section class="panel hide" id="datasetPanel" style="margin-top:16px">
      <h3>Consultant JSON (current set)</h3>
      <div class="body">
        <div class="copy-row">
          <button class="btn-ghost" id="copyJSON">Copy JSON</button>
        </div>
        <pre id="jsonView"></pre>
      </div>
    </section>
  </div>

<script>
/* ----------------- Load clinicians from adjacent consultant.json ----------------- */
let CLINICIANS = [];

document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('consultant.json', {cache:'no-store'});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    CLINICIANS = await res.json();

    // populate Area dropdown with unique areas (specialties captured so far, not sub-areas)
    const areas = [...new Set(CLINICIANS.map(c => c.area).filter(Boolean))].sort();
    const areaSel = $('area');
    for (const a of areas){
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = a;
      areaSel.appendChild(opt);
    }

    $('stats').textContent = `Loaded ${CLINICIANS.length} consultants.`;
    $('findBtn').disabled = false;

    // optional: live typing
    $('q').addEventListener('input', debounce(runSearch, 200));
  } catch (err) {
    $('stats').textContent = `Failed to load consultant.json (${err.message}).`;
    console.error(err);
  }
});

/* ----------------- (Your) Fuzzy Logic — unchanged core ----------------- */
/* EXACT WORD HIT: +10 per word in common
   FUZZY SUBSTRINGS: for every 2–3 char segment in input found in target text, +len*3 */
function calculateScore(input, targetText) {
  const inputWords = input.toLowerCase().split(/\s+/).filter(Boolean);
  const nameWords  = targetText.toLowerCase().split(/\s+/).filter(Boolean);
  let score = 0;

  for (let i = 0; i < inputWords.length; i++) {
    const inputWord = inputWords[i];
    if (nameWords.indexOf(inputWord) !== -1) {
      score += 10;
    }
  }

  for (let len = 2; len <= 3; len++) {
    for (let i = 0; i < input.length - len + 1; i++) {
      const segment = input.slice(i, i + len).toLowerCase();
      if (segment.trim().length < len) continue;
      if (targetText.toLowerCase().indexOf(segment) !== -1) {
        score += len * 3;
      }
    }
  }
  return score;
}

/* Build the searchable string for each clinician — covers all JSON fields */
function clinicianSearchText(c){
  // join every field value into a flat string, arrays joined by space
  const parts = [];
  for (const [k,v] of Object.entries(c)){
    if (v == null) continue;
    if (Array.isArray(v)) parts.push(v.join(' '));
    else parts.push(String(v));
  }
  return parts.filter(Boolean).join(' ').toLowerCase();
}

/* Optional area hard-filter (if selected) */
function areaMatches(areaFilter, c){
  if (!areaFilter) return true;
  const a = (c.area || '').toLowerCase();
  return a.includes(areaFilter.toLowerCase());
}

/* ----------------- UI ----------------- */
const $ = id => document.getElementById(id);

$('findBtn').addEventListener('click', runSearch);
$('resetBtn').addEventListener('click', () => {
  $('q').value = "";
  $('area').value = "";
  renderResults([]);
  $('stats').textContent = "Cleared.";
});
$('q').addEventListener('keydown', e => { if (e.key==='Enter') runSearch(); });

// Dataset toggle + copy
$('toggleDataset').addEventListener('click', () => {
  const panel = $('datasetPanel');
  const wasHidden = panel.classList.contains('hide');
  panel.classList.toggle('hide');
  $('toggleDataset').textContent = wasHidden ? "Hide Dataset" : "Show Dataset";
  if (wasHidden) $('jsonView').textContent = JSON.stringify(CLINICIANS, null, 2);
});
$('copyJSON').addEventListener('click', () => {
  const txt = JSON.stringify(CLINICIANS, null, 2);
  navigator.clipboard.writeText(txt).then(()=>alert('JSON copied')).catch(()=>alert('Copy failed'));
});

function runSearch(){
  const q = $('q').value.trim();
  const area = $('area').value;

  if (!CLINICIANS.length){
    $('stats').textContent = 'Dataset not loaded.';
    return;
  }

  const scored = CLINICIANS
    .filter(c => areaMatches(area, c))
    .map(c => {
      const searchable = clinicianSearchText(c);
      const score = q ? calculateScore(q, searchable) : 0;
      return { clinician: c, score, searchable };
    })
    .filter(x => q ? x.score > 0 : false) // show only matches unless you want "show all"
    .sort((a,b) => b.score - a.score);

  renderResults(scored, q);
  $('stats').textContent = scored.length
    ? `Found ${scored.length} match${scored.length>1?'es':''}.`
    : (q ? `No matches. Try terms like "TURP", "UroLift", "electrophysiology", "dementia".` : `Type a query to begin.`);
}

function renderResults(items, query=""){
  const box = $('results');
  box.innerHTML = "";
  if (!items || !items.length){
    box.innerHTML = `<div class="card muted">No results yet.</div>`;
    return;
  }
  for (const it of items){
    const c = it.clinician;
    const name = c.provider || c["name of individual"] || "—";
    const area = c.area || c["general area"] || "";
    const scoreClass = it.score >= 60 ? "good" : "warn";
    const scoreTxt = it.score.toFixed(0);

    // chips: show "specialties captured so far but not all" → area + sub_area + hospital_affiliations (chips)
    const chips = [];
    if (c.area) chips.push(`<span class="chip">${hl(c.area, query)}</span>`);
    if (c.sub_area) chips.push(`<span class="chip">${hl(c.sub_area, query)}</span>`);
    if (Array.isArray(c.hospital_affiliations)){
      for (const h of c.hospital_affiliations.slice(0,3)){ // cap to avoid overwhelm
        chips.push(`<span class="chip">${hl(h, query)}</span>`);
      }
    }

    // key–value dump of ALL fields present in JSON for this record
    const kv = Object.entries(c).map(([k,v])=>{
      const niceK = toTitle(k);
      const val = Array.isArray(v)
        ? v.map(x=>`<span class="chip">${hl(String(x), query)}</span>`).join(' ')
        : hl(String(v), query);
      return `<div class="kv"><div class="k">${escapeHTML(niceK)}</div><div class="v">${val}</div></div>`;
    }).join("");

    const div = document.createElement('div');
    div.className = "card";
    div.innerHTML = `
      <h4>${escapeHTML(name)} <span class="muted">— ${escapeHTML(area)}</span></h4>
      <div class="muted">Score: <b class="score ${scoreClass}">${scoreTxt}</b></div>
      <div class="chips" style="margin-top:8px">${chips.join(" ")}</div>
      ${kv}
    `;
    box.appendChild(div);
  }

  // make chips add to query (keeps UX from overwhelming menus)
  box.querySelectorAll('.chip').forEach(ch => {
    ch.style.cursor = 'pointer';
    ch.title = 'Add to search';
    ch.addEventListener('click', () => {
      const qEl = $('q');
      const add = ch.textContent.trim();
      const existing = qEl.value.trim();
      qEl.value = existing ? existing + ' ' + add : add;
      runSearch();
      qEl.focus();
    });
  });
}

function hl(text, query){
  const t = String(text);
  if (!query) return escapeHTML(t);
  const qtok = query.toLowerCase().split(/\s+/).filter(x=>x.length>=3);
  if (!qtok.length) return escapeHTML(t);
  let out = escapeHTML(t);
  for (const q of qtok){
    const re = new RegExp(`(${escapeReg(q)})`,"ig");
    out = out.replace(re,'<span class="hl">$1</span>');
  }
  return out;
}

function toTitle(s){
  return String(s)
    .replace(/_/g,' ')
    .replace(/\b\w/g, m => m.toUpperCase());
}

function escapeHTML(s){ return String(s).replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m])); }
function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

function debounce(fn, ms=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

/* Initial state */
renderResults([]);
</script>
</body>
</html>
